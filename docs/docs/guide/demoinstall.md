# **Introduction**

There is a demo of this project which is currently running on my remote server, [here](http://18.185.46.178:8080), and in
this guide I will try to explain how to build a system from the beginning by using features of this project.

## **Installation**
After you obtain the local copy of MalwareTracker by downloading or cloning the repository, you can start to build API 
on your own system. First of all create a virtualenv inside the project folder:

```
../MalwareTracker>virtualenv venv
```

Activate your virtualenv by running:

```
../MalwareTracker>source ./venv/bin/activate
```

Then install the `requirements.txt` after you activated your venv into your `virtualenv (venv)`:
```
(venv) ../MalwareTracker>pip install -r requirements.txt
```

## **Fetching the Malware Data**

There are 2 scripts that fetch malware data from 3 websites, `malshare_script.py` and `rss_tracker.py`. Both scripts
needs a folder to store the data within databases. In the `config.py` file there are 2 database folder variables:

- database_folder

- api_database_folder

`database_folder` is for including all databases, irrespective of their usage, and `api_database_folder` is for including
the databases only will be used for our API.

For this demo we are goind to set these variables to:

    database_folder = './Databases/'
    api_database_folder = database_folder + 'api-db'

---

###**`malshare_script.py`**

By using this script we will be fetching the malware data from [MalShare](https://malshare.com/).

    Note: Do the next steps in the project folder with virtual environment that you've created.

Let's say that we want to fetch malware data since the first day that we can access via MalShare [archive](https://malshare.com/).
To do this we need to follow these steps:

**1)** Get the MD5 hashes and dates via `-uyes` argument of **`malshare_script.py`**.

**2)** Get the details of malware data by using the MD5 hashes that you gather in the first step with `-h2d` argument of
**`malshare_script.py`**.

**3)** Convert the date column which is in epoch format of database that you created in the 2nd step into
datetime format by using **`epoch_to_datetime.py`**.

**4)** Get the details of yesterday into our details database by using bash script named `run_daily_digest.sh` in the 
`bin/` folder.

For the 1st step we need to modify the `config.py` for:

- first_epoch_of_hash
- malshare_api_key
- hashes_db_name

Set `first_epoch_of_hash` to the epoch time of the first date that you want to fetch the MD5 hashes until yesterday. Since
the first date that we can access from MalShare [archive](https://malshare.com/) is **2017-09-14** we are going to set
this variable to epoch format of this date.

    first_epoch_of_hash = 1505347200

Set `malshare_api_key` to the api key that you gather by registering to [MalShare](https://malshare.com/register.php).
Without this key you will not be able to access to APIs.

Set `hashes_db_name` to any name which is ending with '.db' in order to create **sqlite** database. This
database will have 2 tables named `hash_data` and `source_data`. The table that we will be dealing with will be `hash_data`
with 2 columns named `hash` and `date` in epoch format.

    hashes_db_name = 'uyes_hashes.db'

After you set these variables, you can run `malshare_script.py` with `-uyes` argument:

```
(venv) ../MalwareTracker>python3 malshare_script.py -uyes
```

Now in the `Databases/` folder it will be a database named `uyes_hashes.db`. You can see the data inside by:

```
(venv) ../MalwareTracker/Database>sqlite3 uyes_hashes.db 
```

For further information about **sqlite** check this out --> [Sqlite documentation](https://www.sqlite.org/docs.html)

Next step is to fetch details of MD5 hashes that we've just obtained from MalShare. To do this we need to modify 
`config.py` for:

- details_db_name

Set `details_db_name` to any name which is ending with '.db' in order to create **sqlite** database. This database will
have 1 table named `data` This table will be with 4 columns named `hash`, `f_type`, `source`, `date`(in epoch format).

    details_db_name = 'uyes_details.db'
    
After you set this variable, you can run `malshare_script.py` with `-h2d` argument:
```
(venv) ../MalwareTracker>python3 malshare_script.py -h2d
```

Now in the `Databases/` folder it will be a database named `uyes_details.db`. you can see the data inside by:
```
(venv) ../MalwareTracker/Databases>sqlite3 uyes_details.db 
```

Next step is to convert `uyes_detals.db` database's **date** column from epoch format into datetime format. To do this
we need to modify `config.py` for:

- db_to_convert
- converted_db

Set `db_to_convert` to any name which is ending with '.db' in order to provide the information of source database to
`epoch_to_datetime.py` script.

Set `converted_db` to any name which is ending with '.db' in order to provide the information of target database which
will be created to `epoch_to_datetime.py` script.

Since we want to convert the database of details that we've just created `uyes_details.db` with the **date** column in
epoch format, we are going to set `db_to_convert` variable to `uyes_details.db`:

    db_to_convert = 'uyes_details.db'
 
We are going to set `converted_db` name to any name that we want so:

    converted_db = 'malshare.db'

After you set these variable, you can run `epoch_to_datetime.py`:

```
(venv) ../MalwareTracker>python3 epoch_to_datetime.py
```

Here we go, now we have a database named `malshare.db` in `Databases/` folder with all of the malware details since
**2017-09-14**.

But still we are missing **yesterday**'s malware details. So this is what we are going to deal next.

Move the `malshare.db` from `Databases/` folder into `Databases/api-db` folder. 

```
(venv) ../MalwareTracker>mv ./Databases/malshare.db ./Databases/api-db/
```

Run the run_daily_digest.sh which is in `bin/` folder:

```
(venv) ../MalwareTracker>/bin/bash ./bin/run_daily_digest.sh
```

Now we also have details of yesterday malware data.

---

###**`rss_tracker.py`**

By using this script we will be fetching the malware data from:

- [OpenBugBounty RSS feed ](http://feeds.feedburner.com/XSSPosed)

- [CyberCrime-Tracker RSS feed](http://cybercrime-tracker.net/rss.xml)

    Note: Do the next steps in the project folder with virtual environment that you've created.
    
Since these website are not sharing data for old dates, we will be only able to fetch and store their RSS feed in
our databases. To do this follow these steps:

**1)** Modify `config.py` for related variables.

**2)** Run `rss_tracker.py` script.

Now open `config.py` and set these variables to any database name which ends with '.db':

- openbugbounty_db_name

- cybercrimetracker_db_name

For our demo we are going to set these variables to:
    
    openbugbounty_db_name = 'open-bug-bounty.db'
    cybercrimetracker_db_name = 'cyber-crime-tracker.db'
    
Now we are ready to run `rss_tracker.py` script. You can run this script in 2 different ways:

- Run the script itself manually with `python3` command.

```
(venv) ../MalwareTracker>python3 rss_tracker.py
```

OR

- Run `run_rss_tracker.sh` bash script and let it to handle everything.

```
(venv) ../MalwareTracker>/bin/bash ./bin/run_rss_tracker.sh
```

After you run one of these statements, it will be created 2 databases with the names that you've just provided to
`openbugbounty_db_name` and `cybercrimetracker_db_name` variables in `config.py`.

Now we have malware data from 3 different sources and we are ready to bring online our API.

## **Job Scheduling for the Scripts**

Job scheduling needed to be done for a proper running API in order to fetch malware data from our sources automatically
in a time period that we are going to decide. There are bunch of job scheduling but we are going to use **crontab**.

>For further information about crontab read the [documentation](https://help.ubuntu.com/community/CronHowto).

We are going to set 3 jobs to crontab:

- First job is going to run run_malshare_script.sh for every 20 minutes.

- Second job is going to run run_rss_tracker.sh for every 20 minutes.

- Third job is going to run run_daily_digest.sh at 02.00 am (GMT) every day.

Open a terminal and do the following:

```
(venv) ../MalwareTracker>crontab -e
```

Now you will be seeing the edit screen of crontab. If you are using crontab for the first time you can clear the 
everything inside and add following lines:

    * * * * * /bin/bash ../MalwareTracker/bin/run_rss_tracker.sh
    * * * * * /bin/bash ../MalwareTracker/bin/run_malshare_script.sh
    00 02 * * * /bin/bash ../MalwareTracker/bin/run_daily_digest.sh

Save it and exit. Now if you type **crontab -l** into your terminal you will see 3 jobs that currently working.

So we have collected our data and we set our jobs now it is time to modify `api.py` to get online our server for
our API.Job Scheduling for the Scripts

---

## **Building the API**

API will be serving on a server with **flask**. `api.py` in our project folder will be using for this purpose.

###**`api.py`**

This python file connects our databases to users via flask framework. You can run it on your localhost to test.

`api.py` initally set to work on **localhost:8080** so if you just want to test your API just run this command:

```
(venv) ../MalwareTracker>python3 api.py
```

Now your API is available on your localhost.

If you want to change the port you can done it modifying `api.py`:

    app.run(host='127.0.0.1', port='8080')

Change 8080 to any port that you want. If you remove port parameter your server will be running on port **5000** 
by default.

If you want to run this API on an online server change this line like following:

    app.run(host='0.0.0.0', port='8080')

Now if your IP address is accessible on your server, your website will be online.

>For further information read the [flask documentation](http://flask.pocoo.org/docs/1.0/).



